name: Build and Test

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_TEST_VERSION: '9.0.x'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore CosmosToSqlAssessment.sln
      
    - name: Build
      run: dotnet build CosmosToSqlAssessment.sln --configuration Release --no-restore
      
    - name: Publish build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          bin/Release/
          !bin/Release/**/*.pdb
        retention-days: 30

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET (app + test runtimes)
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          ${{ env.DOTNET_VERSION }}
          ${{ env.DOTNET_TEST_VERSION }}

    - name: Restore dependencies
      run: dotnet restore CosmosToSqlAssessment.sln

    - name: Run unit tests with code coverage
      run: |
        dotnet test tests/CosmosToSqlAssessment.Tests/CosmosToSqlAssessment.Tests.csproj \
          --configuration Release \
          --collect:"XPlat Code Coverage" \
          --settings tests/CosmosToSqlAssessment.Tests/coverage.runsettings \
          --results-directory coverage-results \
          --logger "trx;LogFileName=test-results.trx"

    - name: Enforce coverage threshold (≥ 70 %, excluding Azure-SDK-dependent code)
      run: |
        python3 - <<'EOF'
        import xml.etree.ElementTree as ET
        import sys, glob, os

        # Find the generated Cobertura XML (Azure-dependent classes are already excluded
        # via coverage.runsettings, so the total line-rate reflects testable code only).
        xml_files = glob.glob("coverage-results/**/coverage.cobertura.xml", recursive=True)
        if not xml_files:
            print("::error::No coverage XML found. Did the test step run?")
            sys.exit(1)

        tree = ET.parse(xml_files[0])
        root = tree.getroot()

        line_rate = float(root.attrib.get("line-rate", "0"))
        coverage_pct = line_rate * 100
        threshold_pct = 70.0   # minimum required (target is ≥90% over time)

        print(f"Coverage (excluding Azure-SDK-dependent files): {coverage_pct:.1f}%")
        print(f"Required threshold: {threshold_pct:.0f}%")

        if coverage_pct < threshold_pct:
            print(f"::error::Coverage {coverage_pct:.1f}% is below the required {threshold_pct:.0f}% threshold.")
            sys.exit(1)

        print(f"✅ Coverage check passed ({coverage_pct:.1f}% ≥ {threshold_pct:.0f}%)")
        EOF

    - name: Publish test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          coverage-results/
          **/*.trx
        retention-days: 30

  code-quality:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore CosmosToSqlAssessment.sln
      
    - name: Run security analysis
      run: |
        # Install security analysis tools
        dotnet tool install --global security-scan
        # Note: This is a placeholder - adjust based on your preferred security scanning tools
        echo "Security analysis completed"
      continue-on-error: true
      
    - name: Check for sensitive data
      run: |
        # Check for common sensitive patterns
        if grep -r "password\|secret\|key.*=" --include="*.cs" --include="*.json" --exclude-dir=".git" . ; then
          echo "::warning::Potential sensitive data found"
        fi
        echo "Sensitive data check completed"

  multi-platform-build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore CosmosToSqlAssessment.sln
      
    - name: Build for ${{ matrix.os }}
      run: dotnet build CosmosToSqlAssessment.sln --configuration Release --no-restore
      
    - name: Test help command
      run: dotnet run --project CosmosToSqlAssessment.csproj -- --help
      continue-on-error: true

